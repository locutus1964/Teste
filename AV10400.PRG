* AV10400 - CALCULO E IMPRESSAO DAS VENDAS DO MES POR CLIENTE/CANAL
* SISTEMA ADMINISTRACAO DE EMPRESAS
* ADAO ELI PEREIRA - 02-08-90
*
DO TESTIMP2
  IF CP = 'N'
    RETURN
  ENDIF

IF !FILE('CADWORK1.DBF')
  ? MENSAG('Processar primeiro a sele‡„o de Notas Fiscais - op‡„o a - ENTER')
  =INKEY(0)
  RETURN
ENDIF

? MENSAG('Classificando as Vendas por Cliente... Aguarde')

USE CADWORK1
  INDEX ON SUBS(CGC,1,16) + REF TO CADWORK1.IDX
CLOS DATA
*
? MENSAG('Preparando o Relat¢rio Mensal de Faturamento... Aguarde')
*
PAGCTR = 2
TAMREL = 2
*
SELE D
  USE CO2CLI
  ZAP
SELE A
  USE CADWORK1 INDEX CADWORK1.IDX
*
STOR 0.00 TO VALGER,MVALCLI,MVALBRU,VALBRUT
STOR 0.00 TO VALGL,VALGP,QTDL,QTDP,QTDPP,VALBRUL,VALBRUP,MVALBRUT
STOR 0    TO MQTDGER,PRAMEDT,MPRAMED,PRAMEDL,PRAMEDP,MQTDTOT,MCONT
*
DO WHILE !EOF()
  STOR SUBS(CGC,1,16) TO MCGC
  STOR REF            TO MREF
  STOR MCGC + REF TO KEY

  DO WHILE SUBS(CGC,1,16) + REF = KEY .AND. !EOF()
    STOR (VAL + MVALCLI) TO MVALCLI
    STOR (QTD + MQTDTOT) TO MQTDTOT
    STOR (QTD * PREU)    TO IVALBRU
    STOR (IVALBRU + MVALBRUT) TO MVALBRUT
    STOR (MVALBRU + IVALBRU)  TO MVALBRU
    STOR 1 TO QTDP
    STOR (CP1+CP2+CP3+CP4) TO QTDCP

    IF CP2 > 0
      STOR (QTDP + 1) TO QTDP
    ENDIF

    IF CP3 > 0
      STOR (QTDP + 1) TO QTDP
    ENDIF

    IF CP4 > 0
      STOR (QTDP + 1) TO QTDP
    ENDIF

    IF QTDP > 1
      STOR (QTDCP / QTDP) TO QTDDIAS
    ELSE
      STOR QTDCP TO QTDDIAS
    ENDIF

    STOR VAL(SUBS(DEMI,1,2)) TO VDIA
    IF CPD = 'DFQ'
      IF VDIA < 15
        STOR (QTDDIAS + (15 - VDIA)) TO QTDDIAS
      ELSE
        IF VDIA <> 15 .AND. VDIA < 30
          STOR (QTDDIAS + (30 - VDIA)) TO QTDDIAS
        ENDIF
      ENDIF
    ENDIF
    IF CPD = 'DFM'
      IF VDIA < 30
        STOR (QTDDIAS + (30 - VDIA)) TO QTDDIAS
      ENDIF
    ENDIF
    STOR ((QTDDIAS * VAL) + MPRAMED) TO MPRAMED
    SKIP
  ENDDO
  IF MPRAMED > 0
    STOR (MPRAMED / MVALCLI) TO FPRAMED
  ELSE
    STOR 0 TO FPRAMED
  ENDIF

  SELE D
  APPE BLAN
  REPL CGC WITH MCGC,REF WITH MREF,VALCLI WITH MVALCLI
  REPL QTDTOT WITH MQTDTOT,PRAMED WITH FPRAMED
  REPL VALBRU WITH MVALBRUT
  STOR (MVALCLI + VALGER) TO VALGER
  STOR (MQTDTOT + MQTDGER) TO MQTDGER
  STOR (VALBRUT + MVALBRU) TO VALBRUT
  STOR (MPRAMED + PRAMEDT) TO PRAMEDT
  STOR 0.00 TO MVALCLI,MQTDTOT,MVALBRU,MVALBRUT
  STOR 0    TO MPRAMED,FPRAMED

  SELE A
ENDDO
*
CLOS DATA
*
? MENSAG('Classificando os Clientes pelo valor da Compra... Aguarde')
USE CO2CLI
  INDEX ON CGC + STR((100000000000 - VALCLI),10) TO CADWORK.IDX
CLOS DATA
STOR SPACE(16) TO MCGC
*
SELE B
  USE CLIEN ORDER P_CGC
SELE A
  USE CO2CLI INDEX CADWORK.IDX
*
? MENSAG('Imprimindo o Relat¢rio... Aguarde')
*
DO DEFSAIDA

STOR SPACE(16) TO MCGC
*
REST FROM AV10100 ADDI
if left(m_mmes,2) = '00'
   vcab = 'RELATORIO VENDAS DE '+ right(m_mmes,2) + ' POR CLIENTE'
else
   if empty(m_mmes2)
      vcab = 'RELATORIO VENDAS DE '+ m_mmes + ' POR CLIENTE'
   else
      vcab = 'RELATORIO VENDAS DE '+ m_mmes + ' A ' + m_mmes2 + ' POR CLIENTE'
   endif
endif
DO WHILE !EOF()
  ? CABEC('AV10400',VCAB,131)
  @ 3,1   SAY 'SEQ'
  @ 3,5   SAY 'CODIGO'
  @ 3,22  SAY 'N. GUERRA'
  @ 3,36  SAY 'REFERENCIA'
  @ 3,51  SAY 'VALOR TOTAL'
  @ 3,64  SAY '  QUANTID'
  @ 3,82  SAY 'VAL UNIT'
  @ 3,92  SAY '---PERCENTUAIS---'
  @ 3,112 SAY 'PRAZO'
  @ 3,120 SAY 'DESCONTO'
  @ 4,51  SAY '     DO MES'
  @ 4,84  SAY 'MEDIO'
  @ 4,92  SAY 'S/FATUR'
  @ 4,102 SAY 'S/QUANT'
  @ 4,112 SAY 'MEDIO '
  @ 4,122 SAY ' MEDIO'
  @ 5,1   SAY REPLICATE('-',131)
*
  STOR 6 TO LIN
  STOR SPACE(16) TO MCODCLI
*
  DO WHILE !EOF() .AND. LIN < 60
    SELE A
    STOR MCONT + 1 TO MCONT
    @ LIN,1 SAY STR(MCONT,3)
      IF CGC <> MCGC .OR. LIN = 6
        @ LIN,5 SAY CGC
        STOR CGC TO MCODCLI
          SELE B
            SEEK MCODCLI
              IF .NOT. (EOF() .OR. BOF())
                @ LIN,22 SAY GUE
              ELSE
                @ LIN,22 SAY 'N/CADASTR'
              ENDIF
       ENDIF

    SELE A
    @ LIN,36 SAY REF
    @ LIN,48 SAY VALCLI PICT '99,999,999,999'
    @ LIN,64 SAY QTDTOT PICT '99,999,999'
    STOR (VALCLI / QTDTOT) TO MPREU
    @ LIN,76 SAY MPREU PICT '999,999,999.99'

    IF VALGER > 0
      STOR ((VALCLI / VALGER) * 100) TO MPART
      IF MPART > 0.000
        @ LIN,92 SAY MPART PICT '999.999'
      ENDIF
    ENDIF

    IF MQTDGER > 0
      STOR ((QTDTOT / MQTDGER) * 100) TO MPART
      IF MPART > 0.000
        @ LIN,102 SAY MPART PICT '999.999'
      ENDIF
    ENDIF

      STOR (((VALBRU - VALCLI) / VALBRU) * 100) TO MDESC
        @ LIN,111 SAY PRAMED PICT '99999'
        IF MDESC > 0
          @ LIN,120 SAY MDESC PICT '99999.99'
        ENDIF
      STOR CGC TO MCGC

    SKIP
    IF EOF()

      IF LIN > 55
        LIN = 65
        ? CABEC('AV10400','RELATORIO VENDAS DO MES POR CLIENTE',131)
      ENDIF

      @ LIN+1,1 SAY REPLICATE('-',131)
      STOR LIN + 2 TO LIN
      @ LIN,01 SAY 'R E S U M O   D O   M E S'
        STOR LIN + 1 TO LIN
        @ LIN,10 SAY 'VALOR LIQUIDO'
        @ LIN,30 SAY VALGER PICT '99,999,999,999'
        STOR LIN + 1 TO LIN
        @ LIN,10 SAY 'VALOR BRUTO'
        @ LIN,30 SAY VALBRUT PICT '99,999,999,999'
        STOR LIN + 1 TO LIN
        @ LIN,10 SAY 'QUANTIDADE TOTAL'
        @ LIN,34 SAY MQTDGER PICT '99,999,999'
        STOR LIN + 1 TO LIN
        @ LIN,10 SAY 'PRAZO MEDIO'
        STOR (((VALBRUT - VALGER) / VALBRUT) * 100) TO MDESC
        @ LIN,39 SAY STR((PRAMEDT / VALGER),5)
        STOR LIN + 1 TO LIN
        @ LIN,10 SAY 'DESCONTO MEDIO'
        @ LIN,37 SAY MDESC PICT '9999.99'
        STOR LIN + 1 TO LIN
        @ LIN,01 SAY REPLICATE('-',131)
        @ LIN+1,10 SAY 'F I N A L    D E S T E    R E L A T O R I O'
      ENDIF
    STOR LIN + 1 TO LIN
  ENDDO
ENDDO

DO IMPSAIDA

RETURN
